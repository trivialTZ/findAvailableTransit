<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find Available Transit</title>
    <meta name="description"
        content="Professional tool for finding exoplanet transits based on your location and time.">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="index.css">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Inline styles for things not yet in index.css or specific overrides */
        .about-section {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
        }

        .about-section h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .about-section p {
            margin-bottom: 10px;
        }

        .about-section ul {
            padding-left: 20px;
            margin-bottom: 0;
        }

        .about-section li {
            margin-bottom: 5px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="brand">
                    <h1 data-i18n="title">ðŸ”­ Find Available Transit</h1>
                </div>
                <div id="db-info" data-i18n="initializing">Initializing...</div>
            </div>
            <div class="lang-switch">
                <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                <button class="lang-btn" onclick="setLanguage('zh')">ä¸­æ–‡</button>
            </div>
        </header>

        <div class="about-section">
            <h3 data-i18n="about_title">About this Tool</h3>
            <p data-i18n="about_desc">This tool helps astronomers plan exoplanet transit observations. It calculates
                visibility based on your location and time, filtering for events that occur at night and above a minimum
                altitude.</p>
            <ul style="list-style-type: disc;">
                <li data-i18n="about_li1">Calculates local sidereal time and sun altitude.</li>
                <li data-i18n="about_li2">Filters for transits visible from your location.</li>
                <li data-i18n="about_li3">Data sourced from NASA Exoplanet Archive.</li>
            </ul>
        </div>

        <div class="main-grid">
            <!-- Left: Controls -->
            <div class="card">
                <div class="card-header" data-i18n="configuration">Configuration</div>
                <div class="card-body">
                    <div class="controls-form">
                        <div class="control-group">
                            <label for="obsDate" data-i18n="obs_date">Observation Night</label>
                            <input type="date" id="obsDate">
                        </div>
                        <div class="control-group">
                            <label for="tzOffset" data-i18n="utc_offset">UTC Offset</label>
                            <input type="number" id="tzOffset" value="-7">
                        </div>
                        <div class="control-group">
                            <label for="lat" data-i18n="latitude">Latitude (Â°N)</label>
                            <input type="number" id="lat" value="40.9148" step="0.0001">
                        </div>
                        <div class="control-group">
                            <label for="lon" data-i18n="longitude">Longitude (Â°E)</label>
                            <input type="number" id="lon" value="-73.1257" step="0.0001">
                        </div>
                        <div class="control-group">
                            <label for="elev" data-i18n="elevation">Elevation (m)</label>
                            <input type="number" id="elev" value="15" step="1">
                        </div>
                        <button class="btn-main" id="calcBtn" onclick="calculateTransits()"
                            data-i18n="find_transits">Find Transits</button>
                    </div>
                </div>
            </div>

            <!-- Right: Map -->
            <div class="card map-card">
                <div id="map"></div>
                <div class="map-hint" data-i18n="map_hint">
                    Tap map to set location
                </div>
            </div>
        </div>

        <div id="status-bar">
            <div class="spinner" id="spinner"></div>
            <span id="status-text" data-i18n="ready">Ready. Select a date and location.</span>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th onclick="sortResults('name')" data-i18n="col_planet">Planet</th>
                            <th onclick="sortResults('mag')" data-i18n="col_mag">Mag (V)</th>
                            <th onclick="sortResults('ra')" data-i18n="col_ra">RA</th>
                            <th onclick="sortResults('dec')" data-i18n="col_dec">Dec</th>
                            <th onclick="sortResults('jd_start')" data-i18n="col_start">Start</th>
                            <th onclick="sortResults('jd_mid')" data-i18n="col_mid">Mid</th>
                            <th onclick="sortResults('jd_end')" data-i18n="col_end">End</th>
                            <th onclick="sortResults('alt')" data-i18n="col_alt">Alt @ Mid</th>
                            <th onclick="sortResults('dur')" data-i18n="col_dur">Dur (hr)</th>
                            <th onclick="sortResults('depth')" data-i18n="col_depth">Depth (%)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="10" style="text-align:center; padding: 40px; color: var(--text-muted);"
                                data-i18n="no_data">
                                No data generated yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <span data-i18n="footer">Runs locally in browser. Data source: NASA Exoplanet Archive.</span>
        </footer>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let exoplanetDB = [];
        let currentResults = [];
        let sortState = { col: 'jd_mid', dir: 'asc' };
        let map, marker;
        let currentLang = 'en';

        const MIN_ALT = 30.0;
        const SUN_ALT_LIMIT = -12.0;

        const translations = {
            en: {
                title: "ðŸ”­ Find Available Transit",
                initializing: "Initializing...",
                about_title: "About this Tool",
                about_desc: "This tool helps astronomers plan exoplanet transit observations. It calculates visibility based on your location and time, filtering for events that occur at night and above a minimum altitude.",
                about_li1: "Calculates local sidereal time and sun altitude.",
                about_li2: "Filters for transits visible from your location.",
                about_li3: "Data sourced from NASA Exoplanet Archive.",
                configuration: "Configuration",
                obs_date: "Observation Night",
                utc_offset: "UTC Offset",
                latitude: "Latitude (Â°N)",
                longitude: "Longitude (Â°E)",
                elevation: "Elevation (m)",
                find_transits: "Find Transits",
                map_hint: "Tap map to set location",
                ready: "Ready. Select a date and location.",
                calculating: "Calculating orbits...",
                found_events: "Found {n} events.",
                col_planet: "Planet",
                col_mag: "Mag (V)",
                col_ra: "RA",
                col_dec: "Dec",
                col_start: "Start",
                col_mid: "Mid",
                col_end: "End",
                col_alt: "Alt @ Mid",
                col_dur: "Dur (hr)",
                col_depth: "Depth (%)",
                no_data: "No data generated yet.",
                no_observable: "No observable transits found.",
                footer: "Runs locally in browser. Data source: NASA Exoplanet Archive.",
                db_ready: "Database ready.",
                db_error: "Error loading exoplanets.json",
                loading_db: "Loading DB..."
            },
            zh: {
                title: "ðŸ”­ å¯»æ‰¾ç³»å¤–è¡Œæ˜Ÿå‡Œæ—¥",
                initializing: "åˆå§‹åŒ–ä¸­...",
                about_title: "å…³äºŽæœ¬å·¥å…·",
                about_desc: "æœ¬å·¥å…·å¸®åŠ©å¤©æ–‡å­¦å®¶è§„åˆ’ç³»å¤–è¡Œæ˜Ÿå‡Œæ—¥è§‚æµ‹ã€‚å®ƒæ ¹æ®æ‚¨çš„ä½ç½®å’Œæ—¶é—´è®¡ç®—å¯è§æ€§ï¼Œç­›é€‰å‡ºå‘ç”Ÿåœ¨å¤œé—´ä¸”é«˜äºŽæœ€å°ä»°è§’çš„äº‹ä»¶ã€‚",
                about_li1: "è®¡ç®—åœ°æ–¹æ’æ˜Ÿæ—¶å’Œå¤ªé˜³ä»°è§’ã€‚",
                about_li2: "ç­›é€‰å‡ºæ‚¨æ‰€åœ¨ä½ç½®å¯è§çš„å‡Œæ—¥äº‹ä»¶ã€‚",
                about_li3: "æ•°æ®æ¥è‡ª NASA ç³»å¤–è¡Œæ˜Ÿæ¡£æ¡ˆã€‚",
                configuration: "è§‚æµ‹è®¾ç½®",
                obs_date: "è§‚æµ‹æ—¥æœŸ",
                utc_offset: "UTC æ—¶åŒº",
                latitude: "çº¬åº¦ (Â°N)",
                longitude: "ç»åº¦ (Â°E)",
                elevation: "æµ·æ‹” (m)",
                find_transits: "è®¡ç®—å‡Œæ—¥",
                map_hint: "ç‚¹å‡»åœ°å›¾è®¾ç½®åæ ‡",
                ready: "å‡†å¤‡å°±ç»ªã€‚è¯·é€‰æ‹©æ—¥æœŸå’Œåœ°ç‚¹ã€‚",
                calculating: "æ­£åœ¨è®¡ç®—è½¨é“...",
                found_events: "æ‰¾åˆ° {n} ä¸ªäº‹ä»¶ã€‚",
                col_planet: "è¡Œæ˜Ÿ",
                col_mag: "äº®åº¦ (V)",
                col_ra: "èµ¤ç»",
                col_dec: "èµ¤çº¬",
                col_start: "å¼€å§‹",
                col_mid: "ä¸­ç‚¹",
                col_end: "ç»“æŸ",
                col_alt: "ä»°è§’",
                col_dur: "æ—¶é•¿ (æ—¶)",
                col_depth: "æ·±åº¦ (%)",
                no_data: "æš‚æ— æ•°æ®ã€‚",
                no_observable: "æœªå‘çŽ°å¯è§‚æµ‹çš„å‡Œæ—¥äº‹ä»¶ã€‚",
                footer: "åœ¨æµè§ˆå™¨æœ¬åœ°è¿è¡Œã€‚æ•°æ®æ¥æºï¼šNASA ç³»å¤–è¡Œæ˜Ÿæ¡£æ¡ˆã€‚",
                db_ready: "æ•°æ®åº“å°±ç»ªã€‚",
                db_error: "åŠ è½½ exoplanets.json å‡ºé”™",
                loading_db: "åŠ è½½æ•°æ®åº“..."
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Update buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(lang === 'en' ? 'en' : 'ä¸­æ–‡')) {
                    btn.classList.add('active');
                }
            });

            // Re-render table if data exists to update headers/empty message
            if (currentResults.length > 0 || document.querySelector('#resultsBody td').getAttribute('data-i18n') === 'no_data') {
                // If table is empty (initial state), update the "No data" message
                if (currentResults.length === 0) {
                    const noDataCell = document.querySelector('#resultsBody td');
                    if (noDataCell) {
                        noDataCell.innerText = translations[lang]['no_data'];
                    }
                } else {
                    const firstRow = document.querySelector('#resultsBody tr td');
                    if (firstRow && firstRow.colSpan === 10) {
                        firstRow.innerText = translations[lang]['no_observable'];
                    }
                }
            }

            // Update status text if it's a static message
            const statusText = document.getElementById('status-text');
            if (statusText.innerText === translations['en']['ready'] || statusText.innerText === translations['zh']['ready']) {
                statusText.innerText = translations[lang]['ready'];
            } else if (statusText.innerText.includes('Found') || statusText.innerText.includes('æ‰¾åˆ°')) {
                statusText.innerText = translations[lang]['found_events'].replace('{n}', currentResults.length);
            }
        }

        // --- INITIALIZATION ---
        window.onload = async function () {
            // 1. Init Date
            const today = new Date();
            const localDate = today.toLocaleDateString('en-CA');
            document.getElementById('obsDate').value = localDate;

            // 2. Init Map
            initMap();

            // 3. Load Data
            await loadData();
        };

        function initMap() {
            const latInput = document.getElementById('lat');
            const lonInput = document.getElementById('lon');
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);

            // Initialize Leaflet
            map = L.map('map').setView([lat, lon], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([lat, lon], { draggable: true }).addTo(map);

            // Map Click Event
            map.on('click', function (e) {
                updateLocation(e.latlng.lat, e.latlng.lng);
            });

            // Marker Drag Event
            marker.on('dragend', function (e) {
                const pos = marker.getLatLng();
                updateLocation(pos.lat, pos.lng);
            });

            // Input Change Events
            latInput.addEventListener('change', syncMapToInputs);
            lonInput.addEventListener('change', syncMapToInputs);

            // Fix map sizing on load
            setTimeout(() => { map.invalidateSize(); }, 100);
        }

        function updateLocation(lat, lng) {
            document.getElementById('lat').value = lat.toFixed(4);
            document.getElementById('lon').value = lng.toFixed(4);
            marker.setLatLng([lat, lng]);
        }

        function syncMapToInputs() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            if (!isNaN(lat) && !isNaN(lon)) {
                marker.setLatLng([lat, lon]);
                map.panTo([lat, lon]);
            }
        }

        async function loadData() {
            const dbInfo = document.getElementById('db-info');
            const statusText = document.getElementById('status-text');
            const statusBar = document.getElementById('status-bar');
            const btn = document.getElementById('calcBtn');

            try {
                dbInfo.innerText = translations[currentLang]['loading_db'];
                const response = await fetch('exoplanets.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                exoplanetDB = await response.json();
                dbInfo.innerText = `DB: ${exoplanetDB.length} planets`; // Keep this simple or translate part of it
                statusText.innerText = translations[currentLang]['db_ready'];
            } catch (err) {
                console.error(err);
                dbInfo.innerText = "âŒ Error";
                statusBar.classList.add('error-msg');
                statusText.innerHTML = translations[currentLang]['db_error'];
                btn.disabled = true;
            }
        }

        // --- MAIN LOGIC ---

        async function calculateTransits() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const elev = parseFloat(document.getElementById('elev').value) || 0;
            const dateStr = document.getElementById('obsDate').value;
            const tzOffset = parseFloat(document.getElementById('tzOffset').value);

            if (!dateStr) { alert("Please select a date."); return; }

            // UI Updates
            const statusText = document.getElementById('status-text');
            const spinner = document.getElementById('spinner');
            const statusBar = document.getElementById('status-bar');

            statusBar.classList.remove('error-msg');
            statusText.innerText = translations[currentLang]['calculating'];
            spinner.style.display = 'block';

            // Yield to UI
            await new Promise(r => setTimeout(r, 50));

            const results = [];
            const localNoon = new Date(`${dateStr}T12:00:00`);
            const noonUTC = new Date(localNoon.getTime() - (tzOffset * 3600 * 1000));
            const jdStartWindow = getJD(noonUTC);
            const jdEndWindow = jdStartWindow + 1.0;

            for (let i = 0; i < exoplanetDB.length; i++) {
                const p = exoplanetDB[i];
                if (!p.P || !p.T0 || !p.D) continue;

                const n_approx = Math.ceil((jdStartWindow - p.T0) / p.P);

                for (let n = n_approx; n <= n_approx + 1; n++) {
                    const t_mid = p.T0 + n * p.P;

                    if (t_mid >= jdStartWindow && t_mid <= jdEndWindow) {
                        const halfDurDays = (p.D / 24.0) / 2.0;
                        const t_start = t_mid - halfDurDays;
                        const t_end = t_mid + halfDurDays;

                        // Check visibility for Start, Mid, End
                        const times = [t_start, t_mid, t_end];
                        let visible = true;

                        for (let t of times) {
                            const sunPos = getSunPosition(t);
                            const lst = getLST(t, lon);
                            const sunAlt = getAltitude(sunPos.ra, sunPos.dec, lat, lst);

                            if (sunAlt > SUN_ALT_LIMIT) { visible = false; break; }

                            const planetAlt = getAltitude(p.R, p.d, lat, lst);
                            if (planetAlt < MIN_ALT) { visible = false; break; }
                        }

                        if (!visible) continue;

                        // Calculate Mid Altitude for display
                        const lstMid = getLST(t_mid, lon);
                        const planetAltMid = getAltitude(p.R, p.d, lat, lstMid);

                        results.push({
                            name: p.N,
                            mag: p.V,
                            ra: p.R,
                            dec: p.d,
                            jd_mid: t_mid,
                            jd_start: t_start,
                            jd_end: t_end,
                            alt: planetAltMid,
                            dur: p.D,
                            depth: p.Dp
                        });
                    }
                }
            }

            currentResults = results;
            spinner.style.display = 'none';
            statusText.innerText = translations[currentLang]['found_events'].replace('{n}', results.length);

            // Default sort
            sortResults('jd_mid', 'asc');
        }

        function sortResults(col, forceDir = null) {
            if (currentResults.length === 0) return;

            // Toggle direction if same column clicked
            if (!forceDir) {
                if (sortState.col === col) {
                    sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.col = col;
                    sortState.dir = 'asc'; // Default new col to asc
                }
            } else {
                sortState.col = col;
                sortState.dir = forceDir;
            }

            // Sort Data
            currentResults.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];

                if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
            updateHeaderStyles(col, sortState.dir);
        }

        function updateHeaderStyles(activeCol, dir) {
            const headers = document.querySelectorAll('th');
            const map = {
                'name': 0, 'mag': 1, 'ra': 2, 'dec': 3, 'jd_start': 4, 'jd_mid': 5, 'jd_end': 6, 'alt': 7, 'dur': 8, 'depth': 9
            };
            headers.forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (idx === map[activeCol]) {
                    th.classList.add(`sort-${dir}`);
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            if (currentResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color: var(--text-muted);">${translations[currentLang]['no_observable']}</td></tr>`;
                return;
            }

            const tzOffset = parseFloat(document.getElementById('tzOffset').value);

            const fmtTime = (jd) => {
                const d = getDateFromJD(jd);
                const local = new Date(d.getTime() + (tzOffset * 3600 * 1000));
                return local.toISOString().replace('T', ' ').substring(11, 16);
            };

            currentResults.forEach(r => {
                const tr = document.createElement('tr');

                const magTag = r.mag < 11 ? '<span class="tag tag-bright">Bright</span>' : '';
                const altTag = r.alt > 60 ? 'val-high' : '';

                tr.innerHTML = `
                <td style="font-weight:600; color: var(--primary);">${r.name}</td>
                <td>${r.mag.toFixed(1)} ${magTag}</td>
                <td class="font-mono">${r.ra.toFixed(4)}</td>
                <td class="font-mono">${r.dec.toFixed(4)}</td>
                <td class="font-mono">${fmtTime(r.jd_start)}</td>
                <td class="font-mono" style="font-weight:bold; color: var(--text-main);">${fmtTime(r.jd_mid)}</td>
                <td class="font-mono">${fmtTime(r.jd_end)}</td>
                <td class="${altTag}">${r.alt.toFixed(1)}Â°</td>
                <td>${r.dur.toFixed(1)}</td>
                <td>${r.depth.toFixed(2)}</td>
            `;
                tbody.appendChild(tr);
            });
        }

        // --- ASTRONOMY MATH UTILITIES ---
        function getJD(date) { return (date.getTime() / 86400000.0) + 2440587.5; }
        function getDateFromJD(jd) { return new Date((jd - 2440587.5) * 86400000.0); }
        function toRad(deg) { return deg * Math.PI / 180.0; }
        function toDeg(rad) { return rad * 180.0 / Math.PI; }

        function getGMST(jd) {
            const D = jd - 2451545.0;
            let gmst = 18.697374558 + 24.06570982441908 * D;
            gmst = gmst % 24.0;
            if (gmst < 0) gmst += 24.0;
            return gmst;
        }

        function getLST(jd, lon) {
            const gmst = getGMST(jd);
            let lst = gmst + (lon / 15.0);
            lst = lst % 24.0;
            if (lst < 0) lst += 24.0;
            return lst;
        }

        function getAltitude(ra, dec, lat, lst) {
            const ha = (lst - (ra / 15.0)) * 15.0;
            let ha_norm = ha % 360;
            if (ha_norm > 180) ha_norm -= 360;
            if (ha_norm < -180) ha_norm += 360;

            const sinAlt = Math.sin(toRad(lat)) * Math.sin(toRad(dec)) +
                Math.cos(toRad(lat)) * Math.cos(toRad(dec)) * Math.cos(toRad(ha_norm));
            return toDeg(Math.asin(sinAlt));
        }

        function getSunPosition(jd) {
            const n = jd - 2451545.0;
            const L = (280.460 + 0.9856474 * n) % 360;
            const g = (357.528 + 0.9856003 * n) % 360;
            const lambda = L + 1.915 * Math.sin(toRad(g)) + 0.020 * Math.sin(toRad(2 * g));
            const epsilon = 23.439 - 0.0000004 * n;
            const ra = toDeg(Math.atan2(Math.cos(toRad(epsilon)) * Math.sin(toRad(lambda)), Math.cos(toRad(lambda))));
            const dec = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));
            let ra_corr = ra;
            if (ra_corr < 0) ra_corr += 360;
            return { ra: ra_corr, dec: dec };
        }
    </script>
</body>

</html>