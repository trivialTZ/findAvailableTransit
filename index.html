<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDT Transit Scheduler</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f4f9;
            --card-bg: #ffffff;
            --text: #333;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px; /* Reduced padding for mobile */
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        header {
            border-bottom: 2px solid var(--bg);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        .subtitle { color: #666; font-size: 0.9em; margin-top: 5px; }

        /* Controls Grid - Responsive */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Smaller min-width for phones */
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .control-group { display: flex; flex-direction: column; }
        label { font-size: 0.8em; font-weight: 700; color: #555; margin-bottom: 6px; text-transform: uppercase; }

        /* Inputs touch-friendly */
        input, select {
            padding: 12px; /* Larger touch target */
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: white;
        }
        input:focus { border-color: var(--accent); outline: none; }

        /* Action Button */
        button.btn-main {
            background-color: var(--accent);
            color: white;
            font-weight: 700;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            height: 48px; /* Match input height roughly */
            margin-top: auto;
            width: 100%; /* Full width on mobile by default in grid */
        }
        button.btn-main:hover { background-color: #2980b9; }
        button.btn-main:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Status Bar */
        #status-bar {
            padding: 10px 15px;
            background: #e8f4fd;
            color: #104e8b;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            min-height: 24px;
            flex-wrap: wrap;
        }

        /* Error State */
        .error-msg { background: #fde8e8 !important; color: #c0392b !important; }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Data Table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            border-radius: 6px;
            border: 1px solid #eee;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 900px; /* Force horizontal scroll on small screens */ }
        thead { background-color: var(--primary); color: white; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { font-weight: 600; letter-spacing: 0.5px; font-size: 0.85rem; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f0f7fc; }

        /* Tags and Highlights */
        .val-bright { font-weight: bold; color: #c0392b; }
        .val-high { color: #27ae60; font-weight: bold; }
        .time-cell { font-family: monospace; font-size: 1.05em; color: #444; }

        footer { margin-top: 40px; text-align: center; font-size: 0.8em; color: #888; border-top: 1px solid #eee; padding-top: 20px; }

        /* Mobile specific tweaks */
        @media (min-width: 768px) {
            .controls { grid-template-columns: repeat(4, 1fr) auto; } /* Single row on desktop */
            button.btn-main { width: auto; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>üî≠ Transit Scheduler</h1>
            <div class="subtitle">LDT Observatory Planner</div>
        </div>
        <div style="text-align: right; font-size: 0.85em; color: #666;">
            <span id="db-info">Initializing...</span>
        </div>
    </header>

    <div class="controls">
        <div class="control-group">
            <label for="obsDate">Night (Local)</label>
            <input type="date" id="obsDate">
        </div>
        <div class="control-group">
            <label for="lat">Lat (¬∞N)</label>
            <input type="number" id="lat" value="34.7444" step="0.0001">
        </div>
        <div class="control-group">
            <label for="lon">Lon (¬∞E)</label>
            <input type="number" id="lon" value="-111.4222" step="0.0001">
        </div>
        <div class="control-group">
            <label for="tzOffset">UTC Offset</label>
            <input type="number" id="tzOffset" value="-7">
        </div>
        <button class="btn-main" id="calcBtn" onclick="calculateTransits()">Find Transits</button>
    </div>

    <div id="status-bar">
        <div class="spinner" id="spinner"></div>
        <span id="status-text">Waiting for input...</span>
    </div>

    <div class="table-responsive">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Planet</th>
                    <th>Mag (V)</th>
                    <th>Start (Local)</th>
                    <th>Mid (Local)</th>
                    <th>End (Local)</th>
                    <th>Alt @ Mid</th>
                    <th>Dur (hr)</th>
                    <th>Depth (%)</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr><td colspan="8" style="text-align:center; color:#999; padding: 30px;">Select a date and click 'Find Transits'</td></tr>
            </tbody>
        </table>
    </div>

    <footer>
        Runs in browser. Source: NASA Exoplanet Archive.
    </footer>
</div>

<script>
    // --- GLOBAL STATE ---
    let exoplanetDB = [];
    const MIN_ALT = 30.0; // Minimum altitude to display
    const SUN_ALT_LIMIT = -12.0; // Nautical Twilight

    // --- INITIALIZATION ---
    window.onload = async function() {
        // Set date picker to today
        const today = new Date();
        // Adjust for timezone issue in date inputs
        const localDate = today.toLocaleDateString('en-CA'); // YYYY-MM-DD
        document.getElementById('obsDate').value = localDate;

        // Load Data
        const dbInfo = document.getElementById('db-info');
        const statusText = document.getElementById('status-text');
        const statusBar = document.getElementById('status-bar');
        const btn = document.getElementById('calcBtn');

        try {
            dbInfo.innerText = "Loading data...";
            const response = await fetch('exoplanets.json');

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            exoplanetDB = await response.json();
            dbInfo.innerText = `DB: ${exoplanetDB.length} planets`;
            statusText.innerText = "Database ready. Select a date.";
        } catch (err) {
            console.error(err);
            dbInfo.innerText = "‚ùå Load Error";
            statusBar.classList.add('error-msg');

            // Specific helpful error for local file testing
            if (window.location.protocol === 'file:') {
                statusText.innerHTML = `<b>Security Error:</b> Browsers block opening JSON files directly from your hard drive (file://). <br>Please use a local server (<code>python -m http.server</code>) or upload these files to GitHub.`;
            } else {
                statusText.innerHTML = `Error loading <b>exoplanets.json</b>. Ensure the file exists in the same folder.`;
            }
            btn.disabled = true;
        }
    };

    // --- MAIN LOGIC ---

    async function calculateTransits() {
        const lat = parseFloat(document.getElementById('lat').value);
        const lon = parseFloat(document.getElementById('lon').value);
        const dateStr = document.getElementById('obsDate').value;
        const tzOffset = parseFloat(document.getElementById('tzOffset').value);

        if (!dateStr) { alert("Please select a date."); return; }

        // UI Updates
        const tbody = document.getElementById('resultsBody');
        const statusText = document.getElementById('status-text');
        const spinner = document.getElementById('spinner');
        const statusBar = document.getElementById('status-bar');

        statusBar.classList.remove('error-msg');
        tbody.innerHTML = '';
        statusText.innerText = "Calculating orbits...";
        spinner.style.display = 'block';

        // Allow UI to render before heavy calc
        await new Promise(r => setTimeout(r, 50));

        const results = [];

        // 1. Define Search Window (Noon to Noon Local Time)
        const localNoon = new Date(`${dateStr}T12:00:00`);
        const noonUTC = new Date(localNoon.getTime() - (tzOffset * 3600 * 1000));

        const jdStart = getJD(noonUTC);
        const jdEnd = jdStart + 1.0;

        // 2. Iterate all planets
        for (let i = 0; i < exoplanetDB.length; i++) {
            const p = exoplanetDB[i];
            if (!p.P || !p.T0 || !p.D) continue;

            const n_approx = Math.ceil((jdStart - p.T0) / p.P);

            for (let n = n_approx; n <= n_approx + 1; n++) {
                const t_mid = p.T0 + n * p.P;

                // Is transit within window?
                if (t_mid >= jdStart && t_mid <= jdEnd) {

                    // A. Is it Dark?
                    const sunPos = getSunPosition(t_mid);
                    const lst = getLST(t_mid, lon);
                    const sunAlt = getAltitude(sunPos.ra, sunPos.dec, lat, lst);

                    if (sunAlt > SUN_ALT_LIMIT) continue;

                    // B. Is Planet visible?
                    const planetAlt = getAltitude(p.R, p.d, lat, lst);
                    if (planetAlt < MIN_ALT) continue;

                    // C. Calculate Start/End Times
                    // Duration is in hours. JD is days.
                    // Half duration in days = (Duration / 24) / 2
                    const halfDurDays = (p.D / 24.0) / 2.0;
                    const t_start = t_mid - halfDurDays;
                    const t_end = t_mid + halfDurDays;

                    results.push({
                        name: p.N,
                        mag: p.V,
                        jd_mid: t_mid,
                        jd_start: t_start,
                        jd_end: t_end,
                        alt: planetAlt,
                        dur: p.D,
                        depth: p.Dp
                    });
                }
            }
        }

        // Sort by Time
        results.sort((a, b) => a.jd_mid - b.jd_mid);

        // Render
        spinner.style.display = 'none';
        statusText.innerText = `Found ${results.length} observable events for ${dateStr}.`;

        if (results.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px;">No observable transits (Alt > ${MIN_ALT}¬∞, Sun < ${SUN_ALT_LIMIT}¬∞).</td></tr>`;
            return;
        }

        results.forEach(r => {
            const tr = document.createElement('tr');

            // Formatting function
            const fmtTime = (jd) => {
                const d = getDateFromJD(jd);
                const local = new Date(d.getTime() + (tzOffset * 3600 * 1000));
                return local.toISOString().replace('T', ' ').substring(11, 16);
            };

            const tStart = fmtTime(r.jd_start);
            const tMid = fmtTime(r.jd_mid);
            const tEnd = fmtTime(r.jd_end);

            const magClass = r.mag < 11 ? 'val-bright' : '';
            const altClass = r.alt > 50 ? 'val-high' : '';

            tr.innerHTML = `
                <td style="font-weight:600">${r.name}</td>
                <td class="${magClass}">${r.mag.toFixed(1)}</td>
                <td class="time-cell">${tStart}</td>
                <td class="time-cell" style="font-weight:bold">${tMid}</td>
                <td class="time-cell">${tEnd}</td>
                <td class="${altClass}">${r.alt.toFixed(1)}¬∞</td>
                <td>${r.dur.toFixed(1)} h</td>
                <td>${r.depth.toFixed(2)}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- ASTRONOMY MATH UTILITIES ---
    function getJD(date) { return (date.getTime() / 86400000.0) + 2440587.5; }
    function getDateFromJD(jd) { return new Date((jd - 2440587.5) * 86400000.0); }
    function toRad(deg) { return deg * Math.PI / 180.0; }
    function toDeg(rad) { return rad * 180.0 / Math.PI; }

    function getGMST(jd) {
        const D = jd - 2451545.0;
        let gmst = 18.697374558 + 24.06570982441908 * D;
        gmst = gmst % 24.0;
        if (gmst < 0) gmst += 24.0;
        return gmst;
    }

    function getLST(jd, lon) {
        const gmst = getGMST(jd);
        let lst = gmst + (lon / 15.0);
        lst = lst % 24.0;
        if (lst < 0) lst += 24.0;
        return lst;
    }

    function getAltitude(ra, dec, lat, lst) {
        const ha = (lst - (ra / 15.0)) * 15.0;
        let ha_norm = ha % 360;
        if (ha_norm > 180) ha_norm -= 360;
        if (ha_norm < -180) ha_norm += 360;

        const sinAlt = Math.sin(toRad(lat)) * Math.sin(toRad(dec)) +
                       Math.cos(toRad(lat)) * Math.cos(toRad(dec)) * Math.cos(toRad(ha_norm));
        return toDeg(Math.asin(sinAlt));
    }

    function getSunPosition(jd) {
        const n = jd - 2451545.0;
        const L = (280.460 + 0.9856474 * n) % 360;
        const g = (357.528 + 0.9856003 * n) % 360;
        const lambda = L + 1.915 * Math.sin(toRad(g)) + 0.020 * Math.sin(toRad(2*g));
        const epsilon = 23.439 - 0.0000004 * n;
        const ra = toDeg(Math.atan2(Math.cos(toRad(epsilon)) * Math.sin(toRad(lambda)), Math.cos(toRad(lambda))));
        const dec = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));
        let ra_corr = ra;
        if (ra_corr < 0) ra_corr += 360;
        return { ra: ra_corr, dec: dec };
    }
</script>
</body>
</html>