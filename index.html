<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find Available Transit</title>
    <meta name="description"
        content="Professional tool for finding exoplanet transits based on your location and time.">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="index.css">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>

    <div class="container">
        <header>
            <div class="brand">
                <h1>Find Available Transit</h1>
                <div class="subtitle">Professional Observatory Planner</div>
            </div>
            <div id="db-info">Initializing...</div>
        </header>

        <div class="main-grid">
            <!-- Left: Controls -->
            <div class="card">
                <div class="card-header">Configuration</div>
                <div class="card-body">
                    <div class="controls-form">
                        <div class="control-group">
                            <label for="obsDate">Observation Night</label>
                            <input type="date" id="obsDate">
                        </div>
                        <div class="control-group">
                            <label for="tzOffset">UTC Offset</label>
                            <input type="number" id="tzOffset" value="-7">
                        </div>
                        <div class="control-group">
                            <label for="lat">Latitude (°N)</label>
                            <input type="number" id="lat" value="34.7444" step="0.0001">
                        </div>
                        <div class="control-group">
                            <label for="lon">Longitude (°E)</label>
                            <input type="number" id="lon" value="-111.4222" step="0.0001">
                        </div>
                        <button class="btn-main" id="calcBtn" onclick="calculateTransits()">Find Transits</button>
                    </div>
                </div>
            </div>

            <!-- Right: Map -->
            <div class="card" style="padding: 0; display: flex; flex-direction: column;">
                <div id="map"></div>
                <div class="map-hint">
                    Tap map to set location
                </div>
            </div>
        </div>

        <div id="status-bar">
            <div class="spinner" id="spinner"></div>
            <span id="status-text">Ready. Select a date and location.</span>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th onclick="sortResults('name')">Planet</th>
                            <th onclick="sortResults('mag')">Mag (V)</th>
                            <th onclick="sortResults('jd_start')">Start</th>
                            <th onclick="sortResults('jd_mid')">Mid</th>
                            <th onclick="sortResults('jd_end')">End</th>
                            <th onclick="sortResults('alt')">Alt @ Mid</th>
                            <th onclick="sortResults('dur')">Dur (hr)</th>
                            <th onclick="sortResults('depth')">Depth (%)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="8" style="text-align:center; padding: 40px; color: var(--text-muted);">
                                No data generated yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            Runs locally in browser. Data source: NASA Exoplanet Archive.
        </footer>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let exoplanetDB = [];
        let currentResults = [];
        let sortState = { col: 'jd_mid', dir: 'asc' };
        let map, marker;

        const MIN_ALT = 30.0;
        const SUN_ALT_LIMIT = -12.0;

        // --- INITIALIZATION ---
        window.onload = async function () {
            // 1. Init Date
            const today = new Date();
            const localDate = today.toLocaleDateString('en-CA');
            document.getElementById('obsDate').value = localDate;

            // 2. Init Map
            initMap();

            // 3. Load Data
            await loadData();
        };

        function initMap() {
            const latInput = document.getElementById('lat');
            const lonInput = document.getElementById('lon');
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);

            // Initialize Leaflet
            map = L.map('map').setView([lat, lon], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([lat, lon], { draggable: true }).addTo(map);

            // Map Click Event
            map.on('click', function (e) {
                updateLocation(e.latlng.lat, e.latlng.lng);
            });

            // Marker Drag Event
            marker.on('dragend', function (e) {
                const pos = marker.getLatLng();
                updateLocation(pos.lat, pos.lng);
            });

            // Input Change Events
            latInput.addEventListener('change', syncMapToInputs);
            lonInput.addEventListener('change', syncMapToInputs);

            // Fix map sizing on load
            setTimeout(() => { map.invalidateSize(); }, 100);
        }

        function updateLocation(lat, lng) {
            document.getElementById('lat').value = lat.toFixed(4);
            document.getElementById('lon').value = lng.toFixed(4);
            marker.setLatLng([lat, lng]);
        }

        function syncMapToInputs() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            if (!isNaN(lat) && !isNaN(lon)) {
                marker.setLatLng([lat, lon]);
                map.panTo([lat, lon]);
            }
        }

        async function loadData() {
            const dbInfo = document.getElementById('db-info');
            const statusText = document.getElementById('status-text');
            const statusBar = document.getElementById('status-bar');
            const btn = document.getElementById('calcBtn');

            try {
                dbInfo.innerText = "Loading DB...";
                const response = await fetch('exoplanets.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                exoplanetDB = await response.json();
                dbInfo.innerText = `DB: ${exoplanetDB.length} planets`;
                statusText.innerText = "Database ready.";
            } catch (err) {
                console.error(err);
                dbInfo.innerText = "❌ Error";
                statusBar.classList.add('error-msg');
                statusText.innerHTML = "Error loading <b>exoplanets.json</b>. Check console.";
                btn.disabled = true;
            }
        }

        // --- MAIN LOGIC ---

        async function calculateTransits() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const dateStr = document.getElementById('obsDate').value;
            const tzOffset = parseFloat(document.getElementById('tzOffset').value);

            if (!dateStr) { alert("Please select a date."); return; }

            // UI Updates
            const statusText = document.getElementById('status-text');
            const spinner = document.getElementById('spinner');
            const statusBar = document.getElementById('status-bar');

            statusBar.classList.remove('error-msg');
            statusText.innerText = "Calculating orbits...";
            spinner.style.display = 'block';

            // Yield to UI
            await new Promise(r => setTimeout(r, 50));

            const results = [];
            const localNoon = new Date(`${dateStr}T12:00:00`);
            const noonUTC = new Date(localNoon.getTime() - (tzOffset * 3600 * 1000));
            const jdStart = getJD(noonUTC);
            const jdEnd = jdStart + 1.0;

            for (let i = 0; i < exoplanetDB.length; i++) {
                const p = exoplanetDB[i];
                if (!p.P || !p.T0 || !p.D) continue;

                const n_approx = Math.ceil((jdStart - p.T0) / p.P);

                for (let n = n_approx; n <= n_approx + 1; n++) {
                    const t_mid = p.T0 + n * p.P;

                    if (t_mid >= jdStart && t_mid <= jdEnd) {
                        const sunPos = getSunPosition(t_mid);
                        const lst = getLST(t_mid, lon);
                        const sunAlt = getAltitude(sunPos.ra, sunPos.dec, lat, lst);

                        if (sunAlt > SUN_ALT_LIMIT) continue;

                        const planetAlt = getAltitude(p.R, p.d, lat, lst);
                        if (planetAlt < MIN_ALT) continue;

                        const halfDurDays = (p.D / 24.0) / 2.0;

                        results.push({
                            name: p.N,
                            mag: p.V,
                            jd_mid: t_mid,
                            jd_start: t_mid - halfDurDays,
                            jd_end: t_mid + halfDurDays,
                            alt: planetAlt,
                            dur: p.D,
                            depth: p.Dp
                        });
                    }
                }
            }

            currentResults = results;
            spinner.style.display = 'none';
            statusText.innerText = `Found ${results.length} events.`;

            // Default sort
            sortResults('jd_mid', 'asc');
        }

        function sortResults(col, forceDir = null) {
            if (currentResults.length === 0) return;

            // Toggle direction if same column clicked
            if (!forceDir) {
                if (sortState.col === col) {
                    sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.col = col;
                    sortState.dir = 'asc'; // Default new col to asc
                }
            } else {
                sortState.col = col;
                sortState.dir = forceDir;
            }

            // Sort Data
            currentResults.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];

                if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable();
            updateHeaderStyles(col, sortState.dir);
        }

        function updateHeaderStyles(activeCol, dir) {
            const headers = document.querySelectorAll('th');
            const map = {
                'name': 0, 'mag': 1, 'jd_start': 2, 'jd_mid': 3, 'jd_end': 4, 'alt': 5, 'dur': 6, 'depth': 7
            };
            headers.forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (idx === map[activeCol]) {
                    th.classList.add(`sort-${dir}`);
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            if (currentResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px; color: var(--text-muted);">No observable transits found.</td></tr>`;
                return;
            }

            const tzOffset = parseFloat(document.getElementById('tzOffset').value);

            const fmtTime = (jd) => {
                const d = getDateFromJD(jd);
                const local = new Date(d.getTime() + (tzOffset * 3600 * 1000));
                return local.toISOString().replace('T', ' ').substring(11, 16);
            };

            currentResults.forEach(r => {
                const tr = document.createElement('tr');

                const magTag = r.mag < 11 ? '<span class="tag tag-bright">Bright</span>' : '';
                const altTag = r.alt > 60 ? 'val-high' : '';

                tr.innerHTML = `
                <td style="font-weight:600; color: var(--primary);">${r.name}</td>
                <td>${r.mag.toFixed(1)} ${magTag}</td>
                <td class="font-mono">${fmtTime(r.jd_start)}</td>
                <td class="font-mono" style="font-weight:bold; color: var(--text-main);">${fmtTime(r.jd_mid)}</td>
                <td class="font-mono">${fmtTime(r.jd_end)}</td>
                <td class="${altTag}">${r.alt.toFixed(1)}°</td>
                <td>${r.dur.toFixed(1)}</td>
                <td>${r.depth.toFixed(2)}</td>
            `;
                tbody.appendChild(tr);
            });
        }

        // --- ASTRONOMY MATH UTILITIES ---
        function getJD(date) { return (date.getTime() / 86400000.0) + 2440587.5; }
        function getDateFromJD(jd) { return new Date((jd - 2440587.5) * 86400000.0); }
        function toRad(deg) { return deg * Math.PI / 180.0; }
        function toDeg(rad) { return rad * 180.0 / Math.PI; }

        function getGMST(jd) {
            const D = jd - 2451545.0;
            let gmst = 18.697374558 + 24.06570982441908 * D;
            gmst = gmst % 24.0;
            if (gmst < 0) gmst += 24.0;
            return gmst;
        }

        function getLST(jd, lon) {
            const gmst = getGMST(jd);
            let lst = gmst + (lon / 15.0);
            lst = lst % 24.0;
            if (lst < 0) lst += 24.0;
            return lst;
        }

        function getAltitude(ra, dec, lat, lst) {
            const ha = (lst - (ra / 15.0)) * 15.0;
            let ha_norm = ha % 360;
            if (ha_norm > 180) ha_norm -= 360;
            if (ha_norm < -180) ha_norm += 360;

            const sinAlt = Math.sin(toRad(lat)) * Math.sin(toRad(dec)) +
                Math.cos(toRad(lat)) * Math.cos(toRad(dec)) * Math.cos(toRad(ha_norm));
            return toDeg(Math.asin(sinAlt));
        }

        function getSunPosition(jd) {
            const n = jd - 2451545.0;
            const L = (280.460 + 0.9856474 * n) % 360;
            const g = (357.528 + 0.9856003 * n) % 360;
            const lambda = L + 1.915 * Math.sin(toRad(g)) + 0.020 * Math.sin(toRad(2 * g));
            const epsilon = 23.439 - 0.0000004 * n;
            const ra = toDeg(Math.atan2(Math.cos(toRad(epsilon)) * Math.sin(toRad(lambda)), Math.cos(toRad(lambda))));
            const dec = toDeg(Math.asin(Math.sin(toRad(epsilon)) * Math.sin(toRad(lambda))));
            let ra_corr = ra;
            if (ra_corr < 0) ra_corr += 360;
            return { ra: ra_corr, dec: dec };
        }
    </script>
</body>

</html>